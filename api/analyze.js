export default async function handler(req, res) {
  // CORSè¨­å®š
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { title, content, studentGrade, reportTopic } = req.body;

    // å…¥åŠ›æ¤œè¨¼
    if (!title || !content || content.length < 100) {
      return res.status(400).json({ 
        error: 'ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ï¼ˆ100æ–‡å­—ä»¥ä¸Šï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' 
      });
    }

    // Gemini APIå‘¼ã³å‡ºã—
    const prompt = `
ã‚ãªãŸã¯ç¤¾ä¼šç§‘æ•™è‚²ã®å°‚é–€å®¶ã¨ã—ã¦ã€æ–‡éƒ¨ç§‘å­¦çœã®å­¦ç¿’æŒ‡å°Žè¦é ˜ã«åŸºã¥ã„ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’åˆ†æžã—ã€å­¦ç¿’è€…ã®å®ŸåŠ›ãƒ¬ãƒ™ãƒ«ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

ã€åˆ†æžå¯¾è±¡ãƒ¬ãƒãƒ¼ãƒˆã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${title}
å†…å®¹: ${content}

ã€å‚è€ƒæƒ…å ±ã€‘
å®Ÿéš›ã®å­¦å¹´: ${studentGrade || 'ä¸æ˜Ž'}
ãƒ†ãƒ¼ãƒžåˆ†é‡Ž: ${reportTopic || 'ä¸æ˜Ž'}

ã€åˆ†æžæŒ‡ç¤ºã€‘
1. ãƒ¬ãƒ™ãƒ«åˆ¤å®šåŸºæº–ï¼š
   å°å­¦æ ¡3-4å¹´ãƒ¬ãƒ™ãƒ«ï¼šåŸºæœ¬çš„ãªäº‹å®Ÿã®è¨˜è¿°ã€èº«è¿‘ãªåœ°åŸŸã¸ã®é–¢å¿ƒ
   å°å­¦æ ¡5-6å¹´ãƒ¬ãƒ™ãƒ«ï¼šæ­´å²çš„äº‹è±¡ã®ç†è§£ã€æ—¥æœ¬ã®å›½åœŸãƒ»ç”£æ¥­ã¸ã®ç†è§£ã€ç°¡å˜ãªæ¯”è¼ƒãƒ»é–¢ä¿‚ã¥ã‘
   ä¸­å­¦æ ¡1å¹´ãƒ¬ãƒ™ãƒ«ï¼šåœ°ç†çš„åˆ†é‡Žã®åŸºç¤Žã€ä¸–ç•Œã¨æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²ã®ç†è§£
   ä¸­å­¦æ ¡2å¹´ãƒ¬ãƒ™ãƒ«ï¼šæ­´å²çš„åˆ†é‡Žã®ç†è§£ã€æ™‚ä»£ã®ç‰¹è‰²ã¨å¤‰åŒ–ã®æŠŠæ¡
   ä¸­å­¦æ ¡3å¹´ãƒ¬ãƒ™ãƒ«ï¼šå…¬æ°‘çš„åˆ†é‡Žã®ç†è§£ã€ç¾ä»£ç¤¾ä¼šã®èª²é¡Œã¸ã®é–¢å¿ƒã€å¤šè§’çš„æ€è€ƒ
   é«˜æ ¡1å¹´ãƒ¬ãƒ™ãƒ«ï¼šåœ°ç†ç·åˆãƒ»æ­´å²ç·åˆã®ç†è§£ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªè¦–ç‚¹
   é«˜æ ¡2-3å¹´ãƒ¬ãƒ™ãƒ«ï¼šæŽ¢ç©¶çš„å­¦ç¿’ã€é«˜åº¦ãªè€ƒå¯ŸåŠ›ã€è«–ç†çš„æ§‹æˆ

2. è©•ä¾¡è¦³ç‚¹ï¼ˆå„100ç‚¹æº€ç‚¹ï¼‰ï¼š
   - çŸ¥è­˜ãƒ»æŠ€èƒ½ï¼šåŸºç¤ŽçŸ¥è­˜ã€è³‡æ–™æ´»ç”¨ã€æƒ…å ±åŽé›†
   - æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾ï¼šè«–ç†æ§‹æˆã€è€ƒå¯ŸåŠ›ã€è¡¨ç¾åŠ›
   - ä¸»ä½“çš„ãªå­¦ç¿’æ…‹åº¦ï¼šé–¢å¿ƒãƒ»æ„æ¬²ã€èª²é¡Œè¨­å®šã€æŽ¢ç©¶å¿ƒ

ã€å›žç­”å½¢å¼ã€‘
## ðŸŽ¯ å®ŸåŠ›ãƒ¬ãƒ™ãƒ«åˆ¤å®š
**åˆ¤å®šçµæžœ: ã€‡ã€‡å¹´ç”Ÿç›¸å½“ãƒ¬ãƒ™ãƒ«**

## ðŸ“Š è©³ç´°è©•ä¾¡
- çŸ¥è­˜ãƒ»æŠ€èƒ½: XX/100ç‚¹
- æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾: XX/100ç‚¹  
- ä¸»ä½“çš„ãªå­¦ç¿’æ…‹åº¦: XX/100ç‚¹
- **ç·åˆè©•ä¾¡: XX/100ç‚¹**

## âœ¨ å„ªç§€ãªç‚¹
[å…·ä½“çš„ãªè‰¯ã„ç‚¹ã‚’3-4ç‚¹]

## ðŸ“ˆ æ”¹å–„ã§ãã‚‹ç‚¹
### çŸ¥è­˜ãƒ»æŠ€èƒ½é¢
[å…·ä½“çš„ãªæ”¹å–„ç‚¹ã¨ä¿®æ­£ææ¡ˆ]

### æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾é¢
[å…·ä½“çš„ãªæ”¹å–„ç‚¹ã¨ä¿®æ­£ææ¡ˆ]

### å­¦ç¿’æ…‹åº¦é¢
[å…·ä½“çš„ãªæ”¹å–„ç‚¹ã¨ä¿®æ­£ææ¡ˆ]

## ðŸš€ æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—æ–¹æ³•
### çŸ­æœŸç›®æ¨™ï¼ˆä»Šã™ãã§ãã‚‹ã“ã¨ï¼‰
1. [å…·ä½“çš„ãªæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
2. [å…·ä½“çš„ãªæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]  
3. [å…·ä½“çš„ãªæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

### ä¸­æœŸç›®æ¨™ï¼ˆæ¬¡ã®æ®µéšŽã‚’ç›®æŒ‡ã™ãŸã‚ã«ï¼‰
1. [ç™ºå±•çš„ãªå­¦ç¿’ææ¡ˆ]
2. [ç™ºå±•çš„ãªå­¦ç¿’ææ¡ˆ]
3. [ç™ºå±•çš„ãªå­¦ç¿’ææ¡ˆ]

â€»åˆ¤å®šã¯å†…å®¹ã®è³ªãƒ»æ·±ã•ãƒ»è¡¨ç¾åŠ›ã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã€å­¦å¹´ã«é–¢ä¿‚ãªãå®¢è¦³çš„ã«è¡Œã£ã¦ãã ã•ã„ã€‚
`;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${process.env.GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: prompt
            }]
          }]
        })
      }
    );

    if (!response.ok) {
      throw new Error('Gemini API error');
    }

    const data = await response.json();
    const analysis = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!analysis) {
      throw new Error('No analysis result');
    }

    res.json({
      success: true,
      analysis: analysis
    });

  } catch (error) {
    console.error('Analysis error:', error);
    res.status(500).json({
      error: 'AIåˆ†æžã‚¨ãƒ©ãƒ¼',
      message: 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„'
    });
  }
}
